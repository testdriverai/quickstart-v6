version: 6.0.0
session: 67f00511acbd9ccac373edf7
steps:
  # Sample PRERUN script
  # Runs BEFORE each test in the suite
  # to run other scripts when provisioning a machine, see provision.yaml
  # to run scripts after a test, see postrun.yaml
  # Docs for `exec` command: https://docs.testdriver.ai/commands/exec
  # Docs for lifecycle scripts: https://docs.testdriver.ai/guide/lifecycle
  - prompt: launch chrome for testing and setup dashcam
    commands:
      # this script starts chrome for testing with a userprofile that has password manager disabled and sets up TestDriver Dashcam for replays and logs
      - command: exec
        lang: pwsh
        code: |
          $WorkDir = Join-Path $env:TEMP "TestDriverChromeRunner"
          Write-Host "Working directory: $WorkDir"
          # Paths that are deterministic from WorkDir
          $extensionPath = Join-Path (Get-Location) "node_modules/dashcam-chrome/build"

          if (-not (Test-Path $extensionPath)) {
            Write-Error "Dashcam extension not found at '$extensionPath'"
            exit 1
          }

          # Fresh user-data-dir per launch
          $profilePath = Join-Path $env:TEMP ("chrome-profile-{0}" -f (Get-Random))

          Write-Host "Extension path: $extensionPath"
          Write-Host "Chrome user data dir: $profilePath"

          # Build Chrome args. Quote paths that may contain spaces.
          $chromeArgs = @(
            "--start-maximized",
            "--load-extension=""$extensionPath""",
            "--user-data-dir=""$profilePath""",
            "--no-first-run",
            "--no-default-browser-check",
            "--disable-infobars",
            "${TD_WEBSITE}"
          )

          # Join into a single string for cmd.exe
          $argString = ($chromeArgs -join ' ')

          # Launch via npx
          Start-Process "cmd.exe" -ArgumentList "/c", "npx @puppeteer/browsers launch chrome -- $argString"

          Write-Host "Launch script complete."
      - command: wait-for-text
        text: ${TD_WEBSITE}
        timeout: 120000
      - command: exec
        lang: pwsh
        code: |
          dashcam track --name="Web Logs" --type="web" --pattern="*"
          dashcam track --name=TestDriver --type=application --pattern="C:\Users\testdriver\Documents\testdriver.log"
      - command: exec
        lang: pwsh
        code: dashcam start
